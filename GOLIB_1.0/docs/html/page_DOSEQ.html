<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GOLIB: Local Dynamic Optimization using IPOPT, CVODES and FADBAD++ (Sequential Approach)</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">GOLIB
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('page_DOSEQ.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Local Dynamic Optimization using IPOPT, CVODES and FADBAD++ (Sequential Approach) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="author"><dt><b>Author:</b></dt><dd>Benoit C. Chachuat </dd></dl>
<dl class="version"><dt><b>Version:</b></dt><dd>0.1 </dd></dl>
<dl class="date"><dt><b>Date:</b></dt><dd>2011 </dd></dl>
<dl class="bug"><dt><b><a class="el" href="bug.html#_bug000004">Bug:</a></b></dt><dd>No known bugs.</dd></dl>
<p>Consider a dynamic optimization (DO) problem of the form </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \min_{{\bf p}\in P}\ &amp; \phi_0({\bf p}, {\bf x}(t_0),\ldots,{\bf x}(t_N)) + \int_{t_0}^{t_N} \psi_0({\bf p}, {\bf x}(t))\, dt\\ \text{s.t.} \ &amp; \phi_k({\bf p}, {\bf x}(t_0),\ldots,{\bf x}(t_N)) + \int_{t_0}^{t_N} \psi_k({\bf p}, {\bf x}(t))\, dt \{\geq,=,\leq\} 0, \quad k=1,\ldots,n_c\\ &amp; \dot{{\bf x}}(t)={\bf f}({\bf p},{\bf x}(t)),\ t\in(t_0,t_{N}]; \quad {\bf x}(t_0)={\bf h}({\bf p}) \end{align*}" src="form_33.png"/>
</p>
<p> where <img class="formulaInl" alt="${\bf p}\in P\subset\mathbb{R}^{n_p}$" src="form_34.png"/>, <img class="formulaInl" alt="${\bf x}\in\mathbb{R}^{n_x}$" src="form_35.png"/>, and the real-valued functions <img class="formulaInl" alt="${\bf f}$" src="form_36.png"/>, <img class="formulaInl" alt="${\bf h}$" src="form_37.png"/>, <img class="formulaInl" alt="$\phi_k$" src="form_38.png"/> and <img class="formulaInl" alt="$\psi_k$" src="form_39.png"/> are twice continuously differentiable in all their arguments and factorable. The class <a class="el" href="classmc_1_1DOSEQ.html" title="C++ class for local solution of dynamic optimization using IPOPT, CVODES and FADBAD++.">mc::DOSEQ</a> in MC++ solves such DO problems to local optimality, based on the sequential approach. It relies on the software packages <a href="https://projects.coin-or.org/Ipopt">IPOPT</a> for local solution of NLP problems, <a href="https://computation.llnl.gov/casc/sundials/description/description.html">SUNDIALS/CVODES</a> for numerical integration and sensitivity analysis of IVPs in ODEs, and <a href="http://www.fadbad.com/fadbad.html">FADBAD++</a> for automatic differentiation (AD).</p>
<p><a class="el" href="classmc_1_1DOSEQ.html" title="C++ class for local solution of dynamic optimization using IPOPT, CVODES and FADBAD++.">mc::DOSEQ</a> is templated in the DO problem to be solved, which has to be a class derived from <a class="el" href="classmc_1_1DOSTRUCT.html" title="C++ base class for dynamic optimization problem formulation.">mc::DOSTRUCT</a>. For example, suppose we want to solve the following dynamic optimization problem: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \max_{T,x_1^0,u_1,\ldots,u_N}\ &amp; T \\ \text{s.t.} \ &amp; x_1(1) = 1\\ &amp; x_2(1) = 0\\ &amp; \left.\begin{array}{l} \dot{x_1}(t) = x_2(t)\\ \dot{x_2}(t) = (u_k-x_1(t)-2*x_2(t))\theta(t)\\ \dot{\theta}(t) = T \end{array}\right\},\ t\in({\textstyle\frac{k-1}{N},\frac{k}{N}}],\ k=1,\ldots,N\\ &amp; x_1(0) = x_1^0,\ x_2(0) = 0,\ \theta(0) = 0 \end{align*}" src="form_40.png"/>
</p>
<p> with <img class="formulaInl" alt="$N=10$" src="form_44.png"/> stages. The following class is defined: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">      #include &quot;doseq.h&quot;</span>

      <span class="comment">// Number of time stages</span>
      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> NS = 5;
      <span class="comment">// Number of decision variables</span>
      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> NP = 2+NS;
      <span class="comment">// Number of state variables</span>
      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> NX = 3;
      <span class="comment">// Number of constraints</span>
      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> NC = 2;

      <span class="keyword">class </span>DO : <span class="keyword">public</span> mc::DOSTRUCT
      {
      <span class="keyword">public</span>:
        DYNOPT()
          : mc::DOSTRUCT( NP, NX, NC )
          {}

        <span class="comment">// ODEs right-hand side</span>
   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> TX, <span class="keyword">typename</span> TP&gt;
        TX RHS
          ( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ix, <span class="keyword">const</span> TP*p, <span class="keyword">const</span> TX*x, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is )
          {
            assert( ix &lt; nx() );
            <span class="keywordflow">switch</span>( ix ){
              <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> p[0]*x[1];
              <span class="keywordflow">case</span> 1: <span class="keywordflow">return</span> p[0]*(p[2+is]-x[0]-2*x[1])*x[2];
              <span class="keywordflow">case</span> 2: <span class="keywordflow">return</span> p[0];
              <span class="keywordflow">default</span>: <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;invalid size&quot;</span>);
            }
          }
      
        <span class="comment">// Initial conditions</span>
        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
        T IC
          ( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ix, <span class="keyword">const</span> T*p )
          {
            assert( ix &lt; nx() );
            <span class="keywordflow">switch</span>( ix ){
              <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> p[1];
              <span class="keywordflow">case</span> 1: <span class="keywordflow">return</span> 0.;
              <span class="keywordflow">case</span> 2: <span class="keywordflow">return</span> 0.;
              <span class="keywordflow">default</span>: <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;invalid size&quot;</span>);
            }
          }

        <span class="comment">// Objective functional</span>
        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
        std::pair&lt;T,t_OBJ&gt; OBJ
          ( <span class="keyword">const</span> T*p, T* <span class="keyword">const</span>*x, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ns )
          {
            <span class="keywordflow">return</span> std::make_pair( p[0], MIN );
          }

        <span class="comment">// Constraint functionals</span>
        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
        std::pair&lt;T,t_CTR&gt; CTR
          ( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ic, <span class="keyword">const</span> T*p, T* <span class="keyword">const</span>*x, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ns )
          {
            <span class="keywordflow">switch</span>( ic ){
              <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> std::make_pair( x[ns][0]-1., EQ );
              <span class="keywordflow">case</span> 1: <span class="keywordflow">return</span> std::make_pair( x[ns][1]-0., EQ );
              <span class="keywordflow">default</span>: <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;invalid size&quot;</span>);
            }
          }
      };
</pre></div><h2><a class="anchor" id="sec_DOSEQ_solve"></a>
How to Solve a DO Model using mc::DOSEQ?</h2>
<p>Start by defining the time stages <img class="formulaInl" alt="$t_k$" src="form_45.png"/>, parameter set <img class="formulaInl" alt="$P$" src="form_42.png"/> and initial guess <img class="formulaInl" alt="$p_0$" src="form_43.png"/>:</p>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">double</span> p0[NP], tk[NS+1];
  std::pair&lt;double,double&gt; P[NP];
  p0[0] = 1.;   P[0] = std::make_pair( 0.1, 2. );
  p0[1] = 0.5;  P[1] = std::make_pair( -1., 1. );
  tk[0] = 0.;
  <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is=0; is&lt;NS; is++ ){
    P[2+is]  = std::make_pair( -0.5, 1.5 );
    p0[2+is] = 0.;
    tk[1+is] = tk[is]+1./(double)NS;
  }
</pre></div><p>Then, define an <a class="el" href="classmc_1_1DOSEQ.html" title="C++ class for local solution of dynamic optimization using IPOPT, CVODES and FADBAD++.">mc::DOSEQ</a> object:</p>
<div class="fragment"><pre class="fragment">  Ipopt::SmartPtr&lt; mc::DOSEQ&lt;DO&gt; &gt; pDO = <span class="keyword">new</span> <a class="code" href="classmc_1_1DOSEQ.html" title="C++ class for local solution of dynamic optimization using IPOPT, CVODES and FADBAD++.">mc::DOSEQ&lt;DO&gt;</a>;
</pre></div><p>Note that the class <a href="http://www.coin-or.org/Doxygen/Ipopt/class_ipopt_1_1_smart_ptr.html">Ipopt::SmartPtr</a> is used here to comply with the IPOPT guidelines.</p>
<p>The DO model is optimized as follows:</p>
<div class="fragment"><pre class="fragment">  Ipopt::ApplicationReturnStatus status = pDO-&gt;solve( NS, tk, P, p0 );
</pre></div><p>where the first abd second arguments are the number and value of the time stages, the third one is the variable bounds, and the last one is the initial guess used by the optimizer (IPOPT). The return value is of the enumeration type <a href="http://www.coin-or.org/Doxygen/Ipopt/namespace_ipopt.html#efa0497854479cde8b0994cdf132c982">Ipopt::ApplicationReturnStatus</a>.</p>
<p>Finally, the optimization results can be retrieved as follows:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">  #include &lt;iostream&gt;</span>
<span class="preprocessor">  #include &lt;iomanip&gt;</span>

  <span class="keywordflow">if</span>( status == Ipopt::Solve_Succeeded ){
    std::cout &lt;&lt; <span class="stringliteral">&quot;DO (LOCAL) Solution: &quot;</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="stringliteral">&quot;  f* = &quot;</span> &lt;&lt; pDO-&gt;solution().f &lt;&lt; std::endl;
    <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ip=0; ip&lt;NP; ip++ )
      std::cout &lt;&lt; <span class="stringliteral">&quot;  p*(&quot;</span> &lt;&lt; ip &lt;&lt; <span class="stringliteral">&quot;) = &quot;</span> &lt;&lt; pDO-&gt;solution().p[ip] &lt;&lt; std::endl;
  }
</pre></div><p>The following result is displayed:</p>
<div class="fragment"><pre class="fragment">
EXIT: Optimal Solution Found.
DO (LOCAL) SOLUTION: 
  f* = 1.53979
  p*(0) = 1.53979
  p*(1) = 1
  p*(2) = 1.5
  p*(3) = 1.47932
  p*(4) = -0.5
</pre></div> </div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>

    <li class="footer">Generated on Thu Feb 13 2014 20:08:12 for GOLIB by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
